<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>SPERONIS`s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="SPERONIS&#96;s Blog">
<meta property="og:url" content="https://speronis.github.io/index.html">
<meta property="og:site_name" content="SPERONIS&#96;s Blog">
<meta property="og:locale">
<meta property="article:author" content="SPERONIS">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="SPERONIS`s Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SPERONIS`s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://speronis.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-T2Code Agent" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/07/27/T2Code%20Agent/" class="article-date">
  <time class="dt-published" datetime="2025-07-27T12:45:45.186Z" itemprop="datePublished">2025-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="T2Code-Agent-思考"><a href="#T2Code-Agent-思考" class="headerlink" title="T2Code Agent 思考"></a>T2Code Agent 思考</h1><h2 id="T2Code"><a href="#T2Code" class="headerlink" title="T2Code"></a>T2Code</h2><p> 即 Talk To Code，这里的 Talk 可以是自然语言包括 PRD、设计稿或者参考截图，利用大模型 + 知识库 + 工具调用，完成从需求到上线的一整套解决方案。<br> <img src="/./T2Code.drawio.png" alt="T2Code.drawio.png"></p>
<ul>
<li>目前测试下来，LLM 中 Claude Sonnet4 效果最好</li>
<li>为了解决代码的准备性和一致性问题，可以借鉴低代码协议，设计合理的低代码 LCDL，通过 Agent 生成 LCDL 后利用低代码的出码能力进行出码</li>
<li>完整从代码构建到上传 CDN 以及静态站点管理，完整前端应用的发布</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://speronis.github.io/2025/07/27/T2Code%20Agent/" data-id="cmdlogklb000064mhd2irgz6i" data-title="" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-智能体交互协议" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/29/%E6%99%BA%E8%83%BD%E4%BD%93%E4%BA%A4%E4%BA%92%E5%8D%8F%E8%AE%AE/" class="article-date">
  <time class="dt-published" datetime="2025-06-29T11:05:45.363Z" itemprop="datePublished">2025-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最新在团队各个业务中开始落地 Agent，发现在于合作方讨论时存在或多或少的信息 GAP，不可否认现在 AI 行业发展已经达到每周甚至每天都有新的技术或者概念出来，学都学不过来还别说应用了。本文对于 Agent 场景落地过程中涉及到的跟前后端、设计、PD、甚至运营都要对齐的一些信息进行一些思考和总结。</p>
<h2 id="AI-Copilot-和-AI-Agent"><a href="#AI-Copilot-和-AI-Agent" class="headerlink" title="AI Copilot 和 AI Agent"></a>AI Copilot 和 AI Agent</h2><h3 id="1-1-AI-Copilot"><a href="#1-1-AI-Copilot" class="headerlink" title="1.1. AI Copilot"></a>1.1. AI Copilot</h3><p>需要用户的引导，更多地起辅助作用，依赖清晰明确的提示（prompt）来发挥作用。人类与 AI 的工作量相当，AI 根据人类的指令完成初稿，人类负责设定目标、修改调整并最终确认。</p>
<p><img src="https://github.com/SPERONIS/ciza1/blob/main/Pasted%20image%2020250629111738.png?raw=true" alt="[Pasted image 20250629111738.png]"></p>
<h3 id="1-2-AI-Agent"><a href="#1-2-AI-Agent" class="headerlink" title="1.2. AI Agent"></a>1.2. AI Agent</h3><p>具有较强的自主性，可以根据目标自主思考和行动，无需人类的详细指导。它能够独立完成 任务拆分、工具选择、进度控制，并在实现目标后自主结束工作。<br>![[Pasted image 20250629111826.png]]<br>![[Pasted image 20250629111915.png]]</p>
<h3 id="1-3-Agentic-AI"><a href="#1-3-Agentic-AI" class="headerlink" title="1.3. Agentic AI"></a>1.3. Agentic AI</h3><blockquote>
<p>《AI Agents vs. Agentic AI: A Conceptual Taxonomy, Applications and Challenges》 <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2505.10468">https://arxiv.org/pdf/2505.10468</a></p>
</blockquote>
<p>即高度自主决策 AI，主要体现在多 Agent 的高效协作、高级的推理&amp;计划并对任务进行有效 分解、共享的上下文内存、高度的协作机制，更加强调社会行为和分布式智能。</p>
<h2 id="1-4-小结"><a href="#1-4-小结" class="headerlink" title="1.4. 小结"></a>1.4. 小结</h2><table>
<thead>
<tr>
<th>特性</th>
<th><strong>AI Copilot</strong></th>
<th><strong>AI Agent</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>核心角色</strong></td>
<td>辅助者 (你的智能助⼿)</td>
<td>执⾏者 (可独⽴⾏动的智能体)</td>
</tr>
<tr>
<td><strong>目标</strong></td>
<td>增强⼈类能⼒，提⾼效率</td>
<td>⾃主完成任务</td>
</tr>
<tr>
<td><strong>⾃主级别</strong></td>
<td>低：依赖⼈类指令和决策</td>
<td>⾼：可⾃主规划、决策、执⾏</td>
</tr>
<tr>
<td><strong>交互⽅式</strong></td>
<td>对话式交互（问答、建议、实时协作）</td>
<td>可后台运⾏，⽆需持续交互</td>
</tr>
<tr>
<td><strong>任务范围</strong></td>
<td>单⼀任务 &#x2F; 即时响应</td>
<td>复杂任务链（多步骤、跨⼯具）</td>
</tr>
<tr>
<td><strong>是否拆解任务</strong></td>
<td>通常不主动拆解任务</td>
<td>主动拆解任务为⼦⽬标</td>
</tr>
<tr>
<td><strong>应⽤</strong></td>
<td>GitHub Copilot、Aone Copilot</td>
<td>AutoGPT, Manus</td>
</tr>
</tbody></table>
<p>![[Pasted image 20250629164851.png]]</p>
<h2 id="二、-智能体交互"><a href="#二、-智能体交互" class="headerlink" title="二、 智能体交互"></a>二、 智能体交互</h2><h3 id="2-1-什么是智能体交互"><a href="#2-1-什么是智能体交互" class="headerlink" title="2.1. 什么是智能体交互"></a>2.1. 什么是智能体交互</h3><p>智能体交互式解决的是如何连接：人 + 智能体 + 计算机，其包含了 Copilot 的交互形态 + Agent 的执行内核。智能体交互涉及单智能体与多智能体之间的协作、人机交互以及环境互 动等多个层面。从风控产品视角来说就是通过友好的交互帮助运营&#x2F;产研与智能体有更好的协同。</p>
<h3 id="2-2-智能体交互方式"><a href="#2-2-智能体交互方式" class="headerlink" title="2.2. 智能体交互方式"></a>2.2. 智能体交互方式</h3><ul>
<li>常见的 4 种交互方式： CopilotPopup，在页面通过浮层方式弹出交互对话框</li>
<li>CopilotSidebar，在页面左侧平行位置展示交互对话框</li>
<li>CopilotChat，沉浸式对话界面 </li>
<li>其他如 HeadlessUI、以及 CopilotChat 与 CopilotSidebar 混合的形式。</li>
<li>Answer 回复区域 </li>
<li>Analysis 分析结果区域</li>
<li>Question 提问区域</li>
<li>DeepAnalysis 深度分析结果区域 </li>
<li>除此之外，html 等信息需要快速转化成用户运行环境上下文</li>
</ul>
<h2 id="2-4-交互协议"><a href="#2-4-交互协议" class="headerlink" title="2.4. 交互协议"></a>2.4. 交互协议</h2><p>工具、Agent、人之前进行交互可通过协议来降低成本、提升扩展性和安全性。目前业界对 工具 + LLM 之间使用 MCP 协议具有一定的共识，Agent + Agent 之间是否需要特定的协议 还有一定的争议，Google 等厂已经设计了 A2A 的协议；而到了 Agent + 人之间的交互协议 则需要使用 AG-UI 协议来进行交互。<br>![[Pasted image 20250629112310.png]]</p>
<h5 id="MCP"><a href="#MCP" class="headerlink" title="MCP"></a>MCP</h5><p>MCP（Model Context Protocol，模型上下文协议），由 Anthropic 于 2024 年底提出，旨在 解决 AI 系统与外部工具、数据源集成时的碎片化和高成本问题。<br>![[Pasted image 20250629112346.png]]</p>
<h4 id="A2A"><a href="#A2A" class="headerlink" title="A2A"></a>A2A</h4><p>谷歌在 2025 年 4 月 9 日的 Google Cloud Next 25 大会上正式开源 A2A 协议，并联合 50 余家科技企业（如 Salesforce、SAP、埃森哲等）共同推动生态建设。A2A 协议基于 HTTP&#x2F;JSON-RPC 等通用标准，支持智能体间的能力发现、任务管理和多模态交互，目标是 解决跨平台智能体协作的 “孤岛” 问题。微软在 2025 年 5 月宣布 Azure AI Foundry 和 Copilot Studio 支持 A2A 协议，并与谷歌合作开发扩大该协议的应用范围。<br>![[Pasted image 20250629112418.png]]</p>
<p>![[Pasted image 20250629112427.png]]<br>![[Pasted image 20250629112439.png]]</p>
<p>Agent注册：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">	<span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;streaming&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;defaultInputModes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;text&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;defaultOutputModes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;text&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;提供天气相关的查询功能&quot;</span><span class="punctuation">,</span></span><br><span class="line">	 <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;天气 Agent&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	 <span class="attr">&quot;skills&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">	 <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://aa.com:1000&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	 <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>请求体中的 message：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">	<span class="attr">&quot;contextId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssdasdas-dasd-sdasdasd-3qdq-45h3rthey5&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;messageId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rh3renfb-2rqdasasdg-5hrtytu-j6urejhs&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;parts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">		<span class="punctuation">&#123;</span> </span><br><span class="line">			<span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">			<span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;杭州今天的天气怎么样？&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回结果中的 Artifacts（请求 Agent 返回的产物）:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span> </span><br><span class="line">	<span class="punctuation">&#123;</span> </span><br><span class="line">		<span class="attr">&quot;artifactId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dasd1-g24gwevdf-45yrwgreu-6i6rjtyerg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">		<span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> </span><br><span class="line">		<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;天气查询结果&quot;</span><span class="punctuation">,</span> </span><br><span class="line">		<span class="attr">&quot;parts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span> </span><br><span class="line">			<span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">			<span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;今天杭州天气晴朗，平均气温 26 摄氏度&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>返回结果中的 Task（被调用 Agent 根据请求所生成的任务）:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">	<span class="attr">&quot;artifacts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span>...<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;contenxtId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;313rt320det20-4grbwtyh-n3ty35tq-4yhraefqf&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;history&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span>...<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;34erfqqet24yghbrw6-46t24g4-45wvdafad-efge&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;task&quot;</span><span class="punctuation">,</span> </span><br><span class="line">	<span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completed&quot;</span> <span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="AG-UI"><a href="#AG-UI" class="headerlink" title="AG-UI"></a>AG-UI</h3><p>AG-UI 通过开放协议标准化了前端应用与 AI Agent 的连接方式。可将其视为 AI 驱动系统的 通用翻译器，无论 Agent 使用哪种语言，AG-UI 都能确保流畅的沟通。AG-UI 帮助开发人员 构建需要实时交互、实时状态流和人机协作的下一代 AI 工作流程。明确且专注于 Agent 与 用户交互层。</p>
<h2 id="三、-AG-UI-协议详解"><a href="#三、-AG-UI-协议详解" class="headerlink" title="三、 AG-UI 协议详解"></a>三、 AG-UI 协议详解</h2><blockquote>
<p>社区已经有 AG-UI 相关的项并具备定的共识：<a target="_blank" rel="noopener" href="https://docs.ag-ui.com/introduction">https://docs.ag-ui.com/introduction</a><br>![[Pasted image 20250629113101.png]]</p>
</blockquote>
<p>注： AG-UI Client：通用的通信客户端（如 HttpAgent）或用于连接现有协议的专用客户端。</p>
<h3 id="3-1-Events"><a href="#3-1-Events" class="headerlink" title="3.1. Events"></a>3.1. Events</h3><p>事件是 Agent 和前端之间通信的基本单元，可实现实时、结构化的交互。</p>
<h3 id="3-2-Agents"><a href="#3-2-Agents" class="headerlink" title="3.2. Agents"></a>3.2. Agents</h3><p>Agents 是 AG-UI 协议中处理请求并生成响应的核心组件。可以让前端应用而无需考虑底层 实现，能通过标准的接口与 AI 服务进行通信。</p>
<h3 id="3-3-Message"><a href="#3-3-Message" class="headerlink" title="3.3. Message"></a>3.3. Message</h3><p>消息遵循与供应商无关的格式，确保在保持一致结构的同时兼容不同的 LLM。使应用可以在 不同的模型厂商（如 OpenAI、Anthropic 或自定义模型）之间切换，而无需更改客户端实 现。<br>基本消息结构：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">BaseMessage</span> &#123;</span><br><span class="line"> <span class="attr">id</span>: <span class="built_in">string</span> <span class="comment">// 唯一的消息 ID</span></span><br><span class="line"> <span class="attr">role</span>: <span class="built_in">string</span> <span class="comment">// 角色, system | user | assistant | tool</span></span><br><span class="line"> <span class="attr">content</span>?: <span class="built_in">string</span> <span class="comment">// 内容（支持 Markdown）</span></span><br><span class="line"> <span class="attr">name</span>?: <span class="built_in">string</span> <span class="comment">// 可选，发送消息的来源</span></span><br><span class="line"> <span class="attr">toolCalls</span>: <span class="title class_">ToolCall</span>[], <span class="comment">// 可选，assistant 的工具调用配置</span></span><br><span class="line"> <span class="attr">toolCallId</span>: <span class="built_in">string</span>，<span class="comment">// 可选，工具调用的结果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对话记录</span></span><br><span class="line">[</span><br><span class="line"> <span class="comment">// 用户 query</span></span><br><span class="line"> &#123;</span><br><span class="line">	 <span class="attr">id</span>: <span class="string">&quot;msg_1&quot;</span>,</span><br><span class="line">	 <span class="attr">role</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">	 <span class="attr">content</span>: <span class="string">&quot;杭州今天天气如何?&quot;</span>,</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="comment">// LLM 返回工具调用消息</span></span><br><span class="line"> &#123;</span><br><span class="line">	 <span class="attr">id</span>: <span class="string">&quot;msg_2&quot;</span>,</span><br><span class="line">	 <span class="attr">role</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">	 <span class="attr">content</span>: <span class="string">&quot;让我为你查询今天杭州的天气&quot;</span>,</span><br><span class="line">	 <span class="attr">toolCalls</span>: [</span><br><span class="line">	 &#123;</span><br><span class="line">		 <span class="attr">id</span>: <span class="string">&quot;call_1&quot;</span>,</span><br><span class="line">		 <span class="attr">type</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">		 <span class="attr">function</span>: &#123;</span><br><span class="line">			 <span class="attr">name</span>: <span class="string">&quot;get_weather&quot;</span>,</span><br><span class="line">			 <span class="attr">arguments</span>: <span class="string">&#x27;&#123;&quot;location&quot;: &quot;杭州&quot;, &quot;unit&quot;: &quot;摄氏度&quot;&#125;&#x27;</span>,</span><br><span class="line">		 &#125;,</span><br><span class="line">	 &#125;],</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="comment">// 工具调用结果给到 LLM</span></span><br><span class="line"> &#123;</span><br><span class="line">	 <span class="attr">id</span>: <span class="string">&quot;result_1&quot;</span>,</span><br><span class="line">	 <span class="attr">role</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">	 <span class="attr">content</span>: <span class="string">&#x27;&#123;&quot;temperature&quot;: 22, &quot;condition&quot;: &quot;晴天&quot;, &quot;humidity&quot;: 25&#125;&#x27;</span>,</span><br><span class="line">	 <span class="attr">toolCallId</span>: <span class="string">&quot;call_1&quot;</span>,</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="comment">// 大模型理解结果并返回</span></span><br><span class="line"> &#123;</span><br><span class="line">	 <span class="attr">id</span>: <span class="string">&quot;msg_3&quot;</span>,</span><br><span class="line">	 <span class="attr">role</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">	 <span class="attr">content</span>: <span class="string">&quot;杭州今天是晴天&quot;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-State"><a href="#3-4-State" class="headerlink" title="3.4.State"></a>3.4.State</h3><p>状态管理可实现Agent与前端应⽤之间的实时同步、状态共享和更新机制。</p>
<h3 id="3-5-Tools"><a href="#3-5-Tools" class="headerlink" title="3.5. Tools"></a>3.5. Tools</h3><p>⼯具，即前端应⽤的 UI 组件，动作等</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Tool</span> &#123;</span><br><span class="line"><span class="attr">name</span>: <span class="built_in">string</span> <span class="comment">// 工具名称</span></span><br><span class="line"><span class="attr">description</span>: <span class="built_in">string</span> <span class="comment">// 对工具的自然语言描述</span></span><br><span class="line"><span class="attr">parameters</span>: &#123;</span><br><span class="line">	 <span class="comment">// 工具的参数</span></span><br><span class="line">	<span class="attr">type</span>: <span class="string">&quot;object&quot;</span></span><br><span class="line">	 <span class="attr">properties</span>: &#123;</span><br><span class="line">		<span class="comment">// 具体的参数配置</span></span><br><span class="line">	&#125;</span><br><span class="line">	 <span class="attr">required</span>: <span class="built_in">string</span>[] <span class="comment">// 必填的参数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前端工具定义</span></span><br><span class="line"><span class="keyword">const</span> userConfirmationTool = &#123;</span><br><span class="line"> <span class="attr">name</span>: <span class="string">&quot;confirmAction&quot;</span>,</span><br><span class="line"> <span class="attr">description</span>: <span class="string">&quot;Ask the user to confirm a specific action before proceeding&quot;</span>,</span><br><span class="line">	 <span class="attr">parameters</span>: &#123;</span><br><span class="line">		<span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">		 <span class="attr">properties</span>: &#123;</span><br><span class="line">		 <span class="attr">action</span>: &#123;</span><br><span class="line">			 <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">			 <span class="attr">description</span>: <span class="string">&quot;The action that needs user confirmation&quot;</span>,</span><br><span class="line">		 &#125;,</span><br><span class="line">		 <span class="attr">importance</span>: &#123;</span><br><span class="line">			 <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">			 <span class="attr">enum</span>: [<span class="string">&quot;low&quot;</span>, <span class="string">&quot;medium&quot;</span>, <span class="string">&quot;high&quot;</span>, <span class="string">&quot;critical&quot;</span>],</span><br><span class="line">			 <span class="attr">description</span>: <span class="string">&quot;The importance level of the action&quot;</span>,</span><br><span class="line">		 &#125;,</span><br><span class="line">	 &#125;,</span><br><span class="line">	 <span class="attr">required</span>: [<span class="string">&quot;action&quot;</span>],</span><br><span class="line">	 &#125;,</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-6-前端研发定义⼀个AG-UI⼯具"><a href="#3-6-前端研发定义⼀个AG-UI⼯具" class="headerlink" title="3.6. 前端研发定义⼀个AG-UI⼯具"></a>3.6. 前端研发定义⼀个AG-UI⼯具</h3><blockquote>
<p>先以微应⽤研发阶段为主，介绍在微应⽤开发过程中，前端研发⼈员如何定义并创建出⼀ 个 AG-UI ⼯具。</p>
</blockquote>
<p>微应⽤下的 AG-UI ⼯具的产出，将遵循微应⽤标准化⽅案。在微应⽤ hulu.manifest 定 义⽂件下，添加 AG-UI ⼯具的定义（需升级 @ali&#x2F;hulu-utils&gt;&#x3D;1.14.0，提供类型⽀持）。下 ⾯是⼀个基本的示例：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/hulu.manifest.ts </span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AgUITool</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@ali/mlops-ag-ui&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">HuluManifest</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@ali/hulu-utils&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">manifest</span>: <span class="title class_">HuluManifest</span> = &#123;</span><br><span class="line">	<span class="comment">/** * 微应用下的页面路由路径 */</span></span><br><span class="line">	<span class="attr">routes</span>: [],</span><br><span class="line">	<span class="comment">// ...other manifest options </span></span><br><span class="line">	<span class="comment">/** * 微应用下导出的给风控智能体使用的 AG-UI 工具 */</span></span><br><span class="line">	<span class="attr">agUITools</span>: [ </span><br><span class="line">		<span class="title class_">AgUITool</span>.<span class="title function_">define</span>( </span><br><span class="line">			<span class="comment">// AG-UI 工具标识名。大驼峰写法 </span></span><br><span class="line">			<span class="string">&#x27;&lt;name&gt;&#x27;</span>, </span><br><span class="line">			<span class="comment">// AG-UI 工具配置项</span></span><br><span class="line">			&#123; </span><br><span class="line">				<span class="comment">// AG-UI 工具的描述。将提供给大模型分析使用 </span></span><br><span class="line">				<span class="attr">description</span>: <span class="string">&#x27;简短描述当前 AG-UI 工具的功能、使用场景&#x27;</span>,</span><br><span class="line">				<span class="comment">// AG-UI 工具源码路径 </span></span><br><span class="line">				<span class="attr">source</span>: <span class="string">&#x27;./src/components/SomeComponent/index.tsx&#x27;</span>, </span><br><span class="line">				<span class="comment">// AG-UI 工具的显示位置</span></span><br><span class="line">				<span class="comment">// - `analysis`: 显示在回复区下的分析结果区域</span></span><br><span class="line">				<span class="comment">// - `deep-analysis`: 显示在深度分析结果区域</span></span><br><span class="line">				<span class="attr">position</span>: <span class="string">&#x27;deep-analysis&#x27;</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">		),</span><br><span class="line">	],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-接⼝设计"><a href="#3-7-接⼝设计" class="headerlink" title="3.7. 接⼝设计"></a>3.7. 接⼝设计</h3><ol>
<li><p>获取历史会话记录：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">GET</span>: <span class="regexp">/session/</span>list</span><br><span class="line">-- </span><br><span class="line"><span class="title class_">Response</span> <span class="attr">data</span>:</span><br><span class="line"></span><br><span class="line">[ </span><br><span class="line">	&#123; </span><br><span class="line">		<span class="string">&quot;sessionId&quot;</span>: <span class="string">&quot;392cb1c7-9751-4198-82fc-6b1b0d7dd3fe&quot;</span>, </span><br><span class="line">		<span class="string">&quot;title&quot;</span>: <span class="string">&quot;你好&quot;</span>, </span><br><span class="line">		<span class="string">&quot;gmtModified&quot;</span>: <span class="string">&quot;2024-06-12T04:02:10.000+00:00&quot;</span> </span><br><span class="line">	&#125; </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据会话 id 获取对话记录：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">GET</span>: <span class="regexp">/chat/</span>findById--</span><br><span class="line"><span class="attr">query</span>: sessionId=392cb1c7-<span class="number">9751</span>-<span class="number">4198</span>-82fc-6b1b0d7dd3fe--</span><br><span class="line"><span class="title class_">Response</span></span><br><span class="line"> <span class="attr">data</span>: [</span><br><span class="line">	 &#123;</span><br><span class="line">		 <span class="attr">queryId</span>: <span class="number">5571</span>,</span><br><span class="line">		 <span class="attr">query</span>: <span class="string">&quot;你好&quot;</span>,</span><br><span class="line">		 <span class="attr">sessionId</span>:  <span class="string">&quot;392cb1c7-9751-4198-82fc-6b1b0d7dd3fe&quot;</span>,</span><br><span class="line">		 <span class="attr">response</span>: &#123;</span><br><span class="line">			 <span class="string">&quot;id&quot;</span>: <span class="number">5479</span>,</span><br><span class="line">			 <span class="string">&quot;response&quot;</span>: <span class="string">&quot;很抱歉，这个问题暂时无法回答～换个问题试试看&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;ossUrlList&quot;</span>: []</span><br><span class="line">		 &#125;</span><br><span class="line">	 &#125;</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建会话</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ST</span>: <span class="regexp">/session/</span>create--</span><br><span class="line"><span class="title class_">Params</span>:</span><br><span class="line"> &#123;</span><br><span class="line"> <span class="string">&quot;title&quot;</span>: <span class="string">&quot;你好&quot;</span></span><br><span class="line"> &#125;--</span><br><span class="line"><span class="title class_">Response</span>:</span><br><span class="line"> <span class="attr">data</span>: <span class="string">&quot;c6eaf4ff-7639-4ba5-8ac0-e65b86cbb165&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>对话流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SSE</span> <span class="attr">POST</span>: chat/query--</span><br><span class="line"><span class="title class_">Params</span>:</span><br><span class="line"> &#123;</span><br><span class="line">	 <span class="string">&quot;sessionId&quot;</span>: <span class="string">&quot;c6eaf4ff-7639-4ba5-8ac0-e65b86cbb165&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;query&quot;</span>: <span class="string">&quot;你好&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;ossUrlList&quot;</span>: []</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> --</span><br><span class="line"><span class="title class_">Response</span> <span class="attr">SSE</span>:</span><br><span class="line"> &#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;我目前无法&quot;</span>,<span class="string">&quot;id&quot;</span>:<span class="number">2994181</span>&#125;</span><br><span class="line"> &#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;我目前无法解决你的问题&quot;</span>,<span class="string">&quot;id&quot;</span>:<span class="number">2994181</span>&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="四、智能体交互协议应⽤"><a href="#四、智能体交互协议应⽤" class="headerlink" title="四、智能体交互协议应⽤"></a>四、智能体交互协议应⽤</h2><blockquote>
<p>社区有个开源项⽬ CopilotKit 提出 CoAgents：⼀个重塑⼈机交互 AI Agent 的前端框架， 通过 Agent UI 和 LangGraph 集成构建下⼀代交互式应⽤程序</p>
</blockquote>
<h3 id="4-1-中台智能体-4-1-1-对话流程"><a href="#4-1-中台智能体-4-1-1-对话流程" class="headerlink" title="4.1. 中台智能体 4.1.1. 对话流程"></a>4.1. 中台智能体 4.1.1. 对话流程</h3><p>方式1：<br>![[Pasted image 20250629162924.png]]</p>
<p>方式2：<br>![[Pasted image 20250629163352.png]]</p>
<h3 id="4-1-2-对话内容协议"><a href="#4-1-2-对话内容协议" class="headerlink" title="4.1.2. 对话内容协议"></a>4.1.2. 对话内容协议</h3><p>统⼀使⽤ LLM 的 MarkDown 格式返回，返回内容携带 Tag 区分 UI Tools：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	id<span class="string">&quot;:2994181,</span></span><br><span class="line"><span class="string">	 &quot;</span>content<span class="string">&quot;:&quot;</span></span><br><span class="line">			 ## 这是你的预审列表</span><br><span class="line">			<span class="string">``</span><span class="string">`ui-tool</span></span><br><span class="line"><span class="string">			 &#123;</span></span><br><span class="line"><span class="string">				 &quot;componentType&quot;: &quot;PRE_LIST&quot;,</span></span><br><span class="line"><span class="string">				 &quot;props&quot;: &#123;</span></span><br><span class="line"><span class="string">					 &quot;taskId&quot;: &quot;123&quot;,</span></span><br><span class="line"><span class="string">					 ...</span></span><br><span class="line"><span class="string">				 &#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>ui-tool</span><br><span class="line"> &#123;</span><br><span class="line"> <span class="string">&quot;componentType&quot;</span>: <span class="string">&quot;PRE_LIST_DETAIL&quot;</span>,</span><br><span class="line"> <span class="string">&quot;props&quot;</span>: &#123;</span><br><span class="line"> <span class="string">&quot;taskId&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-1-3-注册-UI-组件协议"><a href="#4-1-3-注册-UI-组件协议" class="headerlink" title="4.1.3.注册 UI 组件协议"></a>4.1.3.注册 UI 组件协议</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[ &#123;</span><br><span class="line"> &quot;componentType&quot;: &quot;PRE_LIST&quot;, </span><br><span class="line"> &quot;description&quot;: &#x27;简短描述当前 AgentUI 工具的功能、使用场景, 将提供给大模 型分析使用&#x27;, &quot;propTypes&quot;:</span><br><span class="line">  &#123;</span><br><span class="line">   // &quot;UI 工具需要的参数&quot;</span><br><span class="line">    &quot;name&quot;: &#123; // 参数名称 &quot;describe&quot;: &quot;&quot;,</span><br><span class="line">     // 参数的描述，取值要求等</span><br><span class="line">      &quot;type&quot;: &quot;string&quot;</span><br><span class="line">	       // 参数类型,string/int/boolean... </span><br><span class="line">	       &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">     required: [&#x27;name&#x27;]      </span><br><span class="line">&#125; ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>组件定义可以通过⽂档上传到 RAG 知识库，在模型使⽤时通过上下⽂进⾏交互：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">##角色</span><br><span class="line">你是一位前端技术专家，专注于UI组件的应用与解析。</span><br><span class="line">##技能</span><br><span class="line">1. **</span><br><span class="line"> ##限制</span><br><span class="line">2. **</span><br><span class="line">复制代码</span><br><span class="line">组件注册**：根据$&#123;components&#125;注册的组件解析组件用途和参数，为后续工作提供</span><br><span class="line">可选的组件列表。</span><br><span class="line">3. **</span><br><span class="line">组件解析**：根据用户问题，你能够返回可用的UI组件；以及根据上一步获取到的答</span><br><span class="line">案 `$&#123;result&#125;` 理解其含义，分析出UI组件所需的合适参数。你必须确保参数类型、必</span><br><span class="line">填项的正确性。</span><br><span class="line">输出格式**：你的回答必须只有JSON格式：`&#123;componentName: &quot;组件名称&quot;, </span><br><span class="line">props: &#123;...参数对象...&#125;&#125;`。不要回复除 JSON 格式之外的内容。</span><br><span class="line">4. **</span><br><span class="line">缺省组件**：当没有合适的UI组件匹配用户的需求时，你应返回默认组件</span><br><span class="line">`&#123;componentName: &quot;Text&quot;, props: &#123;&quot;value&quot;: `$&#123;result&#125;`&#125;&#125;`。</span><br><span class="line">请确保所有回答都严格遵守上述规定</span><br></pre></td></tr></table></figure>
<p>返回内容 使⽤标准 JSON 结构，由后端编排 LLM + MCP + UI Tools 的⼯具流程，将 MarkDown 内容 与 UI Tools 内容分别返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	 id&quot;:2994181,</span><br><span class="line">	 &quot;content&quot;:&quot;这是你的10条预审列表&quot;,</span><br><span class="line">	 &quot;uiTools&quot;:[</span><br><span class="line">		 &#123;</span><br><span class="line">			 &quot;componentType&quot;: &quot;PRE_LIST&quot;,</span><br><span class="line">			 &quot;props&quot;: &#123;</span><br><span class="line">				 &quot;taskId&quot;: &quot;123&quot;,</span><br><span class="line">				 ...</span><br><span class="line">			 &#125;</span><br><span class="line">		 &#125;</span><br><span class="line">	 ]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>给我的感觉就是，不要限制自己的边界，不要限制想象力，不要闭门造车。在跟着大模型发展的脚步走，就像玉伯大佬说的：大模型就是碾压机，它碾过的地方将一片坦途，我们要紧跟它的脚步，不能走在它前面。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://speronis.github.io/2025/06/29/%E6%99%BA%E8%83%BD%E4%BD%93%E4%BA%A4%E4%BA%92%E5%8D%8F%E8%AE%AE/" data-id="cmchkpg9q0000usmhh056chzb" data-title="" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/31/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-03-31T14:31:29.809Z" itemprop="datePublished">2025-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/31/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://speronis.github.io/2025/03/31/hello-world/" data-id="cm6rz6dua0000zksy4h7ydo7y" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-WebAssembly速通" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/05/WebAssembly%E9%80%9F%E9%80%9A/" class="article-date">
  <time class="dt-published" datetime="2024-03-05T04:08:10.000Z" itemprop="datePublished">2024-03-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/03/05/WebAssembly%E9%80%9F%E9%80%9A/">WebAssembly速通</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近接了一个业务，要将一个端上的能力搞到微信小程序上，在调研后决定使用 WebAssembly 方式接入，很快就把这块的技术调研和技术方案设计完成了，但相关的技术文章较少，本文分享下 WebAssembly 相关的基础知识和一些在项目中使用的踩坑经验。</p>
<h2 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h2><p>引用官网的定义: WebAssembly(缩写为 Wasm) 是一种基于堆栈的虚拟机的二进制指令格式。 Wasm 被设计为编程语言的可移植编译目标，支持在网络上部署客户端和服务器应用程序。目前我们所接触到的 WebAssembly 更多的是 WebAssembly 及其生态;与传统的 JavaScript 不同，WebAssembly 可以提供更高的性能，特别是在需要执行计算密集型任务的情况下。它可以将C 和 C++ 代码打包成可执行的字节码，然后在 Web 浏览器中运行，以提供更快的加载速度和更高的性能。此外，WebAssembly 还支持模块化编程，使开发人员能够更轻松地管理代码，并且具有更高的可移植性。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/WebAssembly">WebAssembly MDN</a></p>
<h2 id="生态语言"><a href="#生态语言" class="headerlink" title="生态语言"></a>生态语言</h2><p>从 WebAssembly 问世以来就展现出巨大的发展潜力，受到业界的广泛关注，各大语言也是积极探索对 WebAssembly 的支持，从老大哥 C&#x2F;C++、javaScript 到新兴的 GO、Rust 等语言，各种编辑工具和生态链层出不穷，一副百花齐放的态势，通过社区的发展，WebAssembly 制定并发布了 WebAssembly System Interface 标准(简称 WASI)后，WebAssembly 的运行环境甚至可以获取到 io 等能力，可见不远的未来服务端也将成为下个WebAssembly 的战场。</p>
<h2 id="生态工具链"><a href="#生态工具链" class="headerlink" title="生态工具链"></a>生态工具链</h2><p>在了解工具链前先认识下 LLVM(Low Level Virtual Machine) 它是一个可重用的编译器和工具链基础设施。它最初是作为编译器前端和优化器的框架而设计的，现在已经发展成为一个完整的编译器基础设施，支持多种编程语言和多个平台。LLVM 的设计目标是提供一个高度灵活的编译器基础设施，具有可重用性、可扩展性和性能优势。采用了模块化的架构将编译过程分为多个阶段，并使用中间表示(intermediate Representation，IR)来表示代码,这种设计使得 LLVM 可以在不同的编译器阶段进行优化、分析和转换，并且可以支持多种目标平台和编程语言如C&#x2F;C++、Swit、Rust 等，通过浏览器把 wasm 文件加载并将字节码继续编译为浏览器所运行的设备的机,器码使其运行。</p>
<p>我们常见的工具有: Emscripten(C&#x2F;C++)，Wasm-pack(Rust)等，限于篇幅本文就只介绍最常用的Emscripten:<br>Emscripten 基于 LLVM libcxx 实现了一套能提供大部分 C&#x2F;C++ 标准库的能力，此外还支持多线程、库导入等方式将大部分 C&#x2F;C++ 工程无缝迁移到 WebAssembly 上。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>老规矩，我们从 0 开始，以一个 helo worid 来进入 WebAssembly 世界(这里使用 C&#x2F;C++ 语言，Emscripten 工具，MacOS 进行阐述，其他工具和环境原理类似)</p>
<ol>
<li>前置工具，安装打工人套件: Git、CMake、Python 等</li>
<li>安装Emscripten: <a target="_blank" rel="noopener" href="https://emscripten,org/docs/getting_started/downloads.html">https://emscripten,org/docs/getting_started&#x2F;downloads.html</a>;</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get the emsdk repo</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/emscripten-core/emsdk.git</span><br><span class="line"><span class="comment"># Enter that directory</span></span><br><span class="line"><span class="built_in">cd</span> emsdk</span><br><span class="line"><span class="comment"># Fetch the latest version of the emsdk (not needed the first time you clone)9 </span></span><br><span class="line">git pull</span><br><span class="line"><span class="comment"># Download and install the latest SDk tools.</span></span><br><span class="line">./emsdk install latest</span><br><span class="line"><span class="comment"># Make the &quot;latest&quot; SDK &quot;active&quot; for the current user. (writes .emscripten file)</span></span><br><span class="line">./emsdk activate latest</span><br><span class="line"><span class="comment"># Activate PATH and other environment variables in the current terminal</span></span><br><span class="line"><span class="built_in">source</span> ./emsdk env.sh</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>创建 hello.c 文件，示例代码:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ol start="4">
<li>执行编译</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc hello.c -o hello.html</span><br></pre></td></tr></table></figure>

<p>编译后将生成一个 .wasm 文件，一个 js 胶水代码文件提供一个全局 Module 对象，封装了</p>
<p>WebAssembly 的一系列操作方法; 以及一个 .htm l模板文件</p>
<h3 id="进一步配置"><a href="#进一步配置" class="headerlink" title="进一步配置"></a>进一步配置</h3><p>接下来我们继续探索 Emscripten 强大的能力吧:</p>
<p>导出 C++ 方法给到 js 层调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emscripten/emscripten.h&gt;</span> <span class="comment">// 导入头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 定义方法导出</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _cplusplus</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXTERN  extern <span class="string">&quot;c&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXTERN</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出方法</span></span><br><span class="line">EXTERN EMSCRIPTEN KEEPALIVE <span class="type">int</span> <span class="title function_">sayHello</span><span class="params">(<span class="built_in">string</span> argc, <span class="type">char</span> ** argv)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sayHello called\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行编译后可以看到在.wasm文件中通过export 导出的方法，在js 胶水代码中也能看到私有方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var _sayHello = Module[<span class="string">&#x27;_sayHello&#x27;</span>] = createExportWrapper(<span class="string">&#x27;sayHello&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>既然是私有方法，肯定不希望外部直接调用，所以我们可以在编译时指定导出具体的 API:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc -o hello,html hello.C -S NO EXIT RUNTIME=<span class="number">1</span> -S <span class="string">&quot;EXPORTED RUNTIME METHODS=[&#x27;ccall&#x27;]&quot;</span></span><br></pre></td></tr></table></figure>

<p>在js中可以通过Module,ccall 调用该 API:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="title class_">Module</span>.<span class="title function_">ccall</span>(</span><br><span class="line">  <span class="string">&quot;sayHello&quot;</span>, <span class="comment">// name of C function</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// return type</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// argument types</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// arguments</span></span><br><span class="line">);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result&#x27;</span>,result); <span class="comment">// result 0</span></span><br></pre></td></tr></table></figure>

<p>同时，我们也可以指定 HTML 模板，在模板代码中使用 <code>&#123;&#123;&#123; SCRIPT&#125;&#125;&#125;</code> 匹配插入 <code>&lt;script async type=&quot;text/javascript&quot;src=&quot;hello.js&quot;&gt;&lt;/script&gt;</code> 可以结合前端语言进行页面展示。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en-us&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Emscripten-Generated Code<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &#123;&#123;&#123; SCRIPT &#125;&#125;&#125; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;mybutton&quot;</span>&gt;</span>点击输入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;mybutton&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>,<span class="function">()=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> result = <span class="title class_">Module</span>.<span class="title function_">ccall</span>(</span></span><br><span class="line"><span class="language-javascript">          <span class="string">&quot;sayHello&quot;</span>, <span class="comment">// name of c function</span></span></span><br><span class="line"><span class="language-javascript">          [<span class="string">&#x27;sting&#x27;</span>],  <span class="comment">// return type</span></span></span><br><span class="line"><span class="language-javascript">          [<span class="string">&#x27;sting&#x27;</span>],  <span class="comment">// argument types</span></span></span><br><span class="line"><span class="language-javascript">          [<span class="string">&#x27;Tom&#x27;</span>], <span class="comment">// arguments</span></span></span><br><span class="line"><span class="language-javascript">        ):</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result&#x27;</span>,result); <span class="comment">// 0</span></span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行编译命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc -o hello.html hello.c --shell-file demo/template.html -S NO EXIT RUNTIME=1 -S <span class="string">&quot;EXPORTED RUNTIME METHODS=[&#x27;ccall&#x27;]&quot;</span></span><br></pre></td></tr></table></figure>


<p>感受到 WebAssembly 的魅力了吗，接下来我们再看几个强大的 Emscripten 编译指令:</p>
<ol>
<li>WASM</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WASM=0 生成 asm.js 格式(适用于 WebAssembly 不支持的情况)</span></span><br><span class="line"><span class="comment"># WASM=1 生成包含 wasm 格式</span></span><br><span class="line"><span class="comment"># WASM=2 asm.js 与 wasm 格式均生成，添加支持判定，优先使用 wasm 格式。</span></span><br><span class="line">-S WASM=1</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ENVIRONMENT</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设定当前的运行环境，避免生成的 js 文件中判定环境，并运行不同的代码</span></span><br><span class="line"><span class="comment"># web - web 浏览器运行环境。</span></span><br><span class="line"><span class="comment">#worker - web worker 支持的运行环境,</span></span><br><span class="line"><span class="comment"># node - Node 环境.</span></span><br><span class="line"><span class="comment"># shell -js 脚本运行环境，如 d8、jsc</span></span><br><span class="line"><span class="comment"># 如果为空则支持所有运行时环境</span></span><br><span class="line">-S ENVIRONMENT=<span class="string">&#x27;web&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p>3.内存模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定内存的大小  </span></span><br><span class="line">-S INITIAL MEMORY=134217728</span><br><span class="line"><span class="comment"># 限制内存大小</span></span><br><span class="line">-S MAXIMUM MEMORY=134217728</span><br><span class="line"><span class="comment"># 是否内存会增长</span></span><br><span class="line">-S ALLOW MEMORY GROWTH=0/1</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>MODULARIZE</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出模块名称，通过常和 MODULARIZE_INSTANCE / MODULARIZE 配合使用</span></span><br><span class="line">-S EXPORT NAME=<span class="string">&#x27;Module&#x27;</span>:</span><br><span class="line"><span class="comment"># 是否生成模块 instance 单粒，返回格式为:&#123;&#125;</span></span><br><span class="line">-S MODULARIZE INSTANCE=0</span><br><span class="line"><span class="comment"># 是否生成模块，返回 function 格式</span></span><br><span class="line">-S MODULARIZE=0;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>EXPORT ES6</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 ES6 模块导出而不是 UMD 导出进行导出。 必须为 ES6 导出启用 MODULARIZE。需要注意低版本浏览器可能不支持它。</span></span><br><span class="line">-S EXPORT ES6=1</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>preload-file</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该命令可以以 preload 模式打包文件或者文件夹，通常可以指定较大的依赖文件或者文本(如.js、.bin 等)</span></span><br><span class="line"><span class="comment"># 执行 --preload-file 后将生成 .data 文件，C/C++ 代码可以通过 fopen 或 xhr 的方式加载并读取文件内容并执行，相比 --embed-file 效率高得多</span></span><br><span class="line">--preload-file hello.text</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Emscripten 本文只列出我们在生产中几个常用的编译指令，更多功能可自行参阅官网说明。</p>
<h2 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h2><p>最简单的方式就是在 HTML 或者 Reactue 等工程中使用，如通过以下指令进行编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCC-S WASM=1 -S WASM_BIGINT -S ENVIRONMENT=Web -S MODULARIZE=1 -S EXPORT_ES6=1 -S USE_ES6_IMOPRT_META=1 -s EXPORET_NAME=<span class="string">&quot;loadWASM&quot;</span> -s EXPORT_RUNTIME_METHODS=<span class="string">&quot;[&#x27;ccal&#x27;]&quot;</span> -s EXPORT_FUNTIONS=<span class="string">&quot;[&#x27;_malloc&#x27;, &#x27;_free&#x27;]&quot;</span> --shell-file demo/template.html</span><br></pre></td></tr></table></figure>

<p>在 hellojs 中我们可以看到 loadWASM 以具名方式导出:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loadWASM = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> scriptDir = <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">moduleArg=&#123;&#125;</span>)&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  ..</span></span><br><span class="line">  )</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> loadWASM;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 hello.html 则可以使用 ES6 方式导入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">import</span> initModule <span class="keyword">from</span><span class="string">&quot;./video index.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">initModule</span>(<span class="title class_">Module</span>);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更推荐使用以下方式，通过 Promise 保证在 js 加载完成后得到可用的 Module 对象，同时，WebAssembly 也提供了onRuntimeInitialized 生命周期来保证胶水代码初始化完成</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> loadWASM <span class="keyword">from</span><span class="string">&quot;./video index.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">loadWASM</span>().<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">Module</span> = modute;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>js 如何将参数传给 C&#x2F;C++，一般情况下 js 向 C&#x2F;C++ 传值可直接根据类型传即可:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.js</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">Module</span>.<span class="title function_">ccall</span>(</span><br><span class="line">  <span class="string">&quot;getResult&quot;</span>,   <span class="comment">// name of c function</span></span><br><span class="line">  <span class="literal">null</span>,         <span class="comment">// return type</span></span><br><span class="line">  [<span class="string">&#x27;number&#x27;</span>],  <span class="comment">// argument types</span></span><br><span class="line">  [<span class="number">111</span>]，      <span class="comment">// arguments</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>但在某些场景下，我们需要将json 字符串、二进制等大量数据传给 C&#x2F;C++，这时可以使用 WebAssembly 提供的 malloc 申请内存方式，将参数放在指针的内存中传递给 C&#x2F;C++:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hello.c</span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;emscripten/emscripten.h&gt;</span></span></span><br><span class="line"><span class="comment">// int Main...</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getResult</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* ptr)</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>，ptr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.js</span></span><br><span class="line"><span class="comment">// 序列化数据，字符串在C/C++ 中是一个以 0 结尾的字符数组</span></span><br><span class="line"><span class="keyword">const</span> jsonstr = <span class="title class_">Module</span>.<span class="title function_">intArrayFromString</span>(<span class="title class_">JSON</span>,<span class="title function_">stringify</span>(data)).<span class="title function_">concat</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 分配内存空间</span></span><br><span class="line"><span class="keyword">const</span> ptr = <span class="title class_">Module</span>. <span class="title function_">malloc</span>(jsonstr.<span class="property">length</span>);</span><br><span class="line"><span class="comment">// 将数据存入新内存中</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property">HEAPU8</span>.<span class="title function_">set</span>(jsonstr, ptr);</span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">Module</span>.<span class="title function_">ccall</span>(</span><br><span class="line">  <span class="string">&quot;getResult&quot;</span>, <span class="comment">// name of c function</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// return type</span></span><br><span class="line">  [<span class="string">&#x27;number&#x27;</span>], <span class="comment">// argument types</span></span><br><span class="line">  [ptr]，<span class="comment">// arguments</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// 一定要记住释放</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="title function_">_free</span>(ptr);</span><br></pre></td></tr></table></figure>

<p>除了 js 将数据传给 C&#x2F;C++，反过来也有 C&#x2F;C++ 向 js 传 字符串等数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.js</span></span><br><span class="line"><span class="comment">// 需要提前知道内存大小，可以使用 C/C++ 提供直接获取某个参数内存大小的方式，也可以通过约定的方式</span></span><br><span class="line"><span class="keyword">const</span> size = <span class="title class_">Module</span>.<span class="title function_">ccall</span>(<span class="string">&#x27;getSize&#x27;</span>,[<span class="string">&#x27;number&#x27;</span>], <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> ptr=<span class="title class_">Module</span>. <span class="title function_">malloc</span>(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">Module</span>.<span class="title function_">ccall</span>(</span><br><span class="line">  <span class="string">&quot;getResult&quot;</span>, <span class="comment">// name of C function</span></span><br><span class="line">  <span class="literal">null</span>,<span class="comment">// return type</span></span><br><span class="line">  [<span class="string">&#x27;number&#x27;</span>], <span class="comment">// argument types</span></span><br><span class="line">  [ptr]，<span class="comment">// arguments</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// 取值</span></span><br><span class="line"><span class="keyword">const</span> resBuffer = <span class="title class_">Module</span>.<span class="property">HEAPU8</span>.<span class="title function_">subarray</span>(ptr, ptr + size);</span><br><span class="line"><span class="keyword">const</span> str = <span class="keyword">new</span> <span class="title class_">TextDecoder</span>().<span class="title function_">decode</span>(resBuffer);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line"><span class="comment">// 一定要记住释放16 Module. free(ptr);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一定要记住一个原则: 谁分配内存，就由谁释放内存!!! 不管什么程序语言，内存生命周期基本是一致的: 分配你所需要的内存、使用分配到的内存(读、写)、不需要时将其释放\归还。在生产环境中，内存泄露的问题较难排除，需要在开发时进行严格要求。</p>
<h3 id="深入"><a href="#深入" class="headerlink" title="深入"></a>深入</h3><p>–preload-file ，在生产环境中，建议使用预加载的方式将一些依赖模块或者文件前面提到了一个指令:进行管理，使用的 js 胶水层会通过 xhr 的方式进行装载，既能加快加载效率，也能减少打包体积:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchRemotePackage</span> (<span class="params">packageName, packageSize, callback, errBack</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">  xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, packageName, <span class="literal">true</span>);</span><br><span class="line">  xhr.<span class="property">responseType</span> =<span class="string">&#x27;arraybuffer&#x27;</span>;</span><br><span class="line">  xhr.<span class="property">onprogress</span> =<span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> url = packageName;</span><br><span class="line">    <span class="keyword">var</span> size = packageSize;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">total</span>) &#123;</span><br><span class="line">      size = event.<span class="property">total</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">loaded</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!xhr.<span class="property">addedTotal</span>) &#123;</span><br><span class="line">        xhr.<span class="property">addedTotal</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Module</span>[<span class="string">&#x27;dataFileDownloads&#x27;</span>]) &#123;</span><br><span class="line">          <span class="title class_">Module</span>[<span class="string">&#x27;dataFileDownloads&#x27;</span>] = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Module</span>.<span class="property">dataFileDownloads</span>[url] = &#123;</span><br><span class="line">          <span class="attr">total</span>: size,</span><br><span class="line">          <span class="attr">loaded</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">Module</span>.<span class="property">dataFileDownloads</span>[url].<span class="property">loaded</span> = event.<span class="property">loaded</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> total = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">var</span> loaded = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">var</span> num = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> download <span class="keyword">in</span> <span class="title class_">Module</span>.<span class="property">dataFileDownloads</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> data =<span class="title class_">Module</span>.<span class="property">dataFileDownloads</span>[download];</span><br><span class="line">        total += data.<span class="property">total</span>;</span><br><span class="line">        loaded += data.<span class="property">loaded</span>;</span><br><span class="line">        num++;</span><br><span class="line">      &#125;</span><br><span class="line">      total = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(total * <span class="title class_">Module</span>.<span class="property">expectedDataFileDownloads</span> / num);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Module</span>[<span class="string">&#x27;setStatus&#x27;</span>]) &#123;</span><br><span class="line">        <span class="title class_">Module</span>[<span class="string">&#x27;setStatus&#x27;</span>](<span class="string">`Downloading data... (<span class="subst">$&#123;loader&#125;</span>/<span class="subst">$&#123;total&#125;</span>)`</span>); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title class_">Module</span>.<span class="property">dataFileDownloads</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Module</span>[<span class="string">&#x27;setStatus&#x27;</span>])&#123;</span><br><span class="line">        <span class="title class_">Module</span>[<span class="string">&#x27;setStatus&#x27;</span>](<span class="string">&#x27;Downloading data...&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;NetworkError for:&quot;</span> + packageName):</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (xhr.<span class="property">status</span> ==<span class="number">200</span> || xhr,status ==<span class="number">304</span> || xhr.<span class="property">status</span> == <span class="number">206</span> || (xhr.<span class="property">status</span> === <span class="number">0</span> &amp;&amp; xhr.<span class="property">response</span>)) &#123;</span><br><span class="line">        packageData=xhr.<span class="property">response</span>;</span><br><span class="line">        <span class="title function_">callback</span>(packageData);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(xhr.<span class="property">statusText</span>+<span class="string">&quot;:&quot;</span>+ xhr.<span class="property">responseURL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">  <span class="keyword">throw</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fetchedCallback = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> fetched = <span class="title class_">Module</span>[<span class="string">&#x27;getPreloadedPackage&#x27;</span>] ? <span class="title class_">Module</span>[<span class="string">&#x27;getPreloadedPackage&#x27;</span>](<span class="variable constant_">REMOTE_PACKAGE_NAME</span>, <span class="variable constant_">REMOTE_PACKAGE_SIZE</span>) : <span class="literal">null</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!fetched) &#123;</span><br><span class="line">  <span class="title function_">fetchRemotePackage</span>(<span class="variable constant_">REMOTE_PACKAGE_NAME</span>, <span class="variable constant_">REMOTE_PACKAGE_SIZE</span>, <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fetchedCallback) &#123;</span><br><span class="line">      <span class="title function_">fetchedCallback</span>(data);</span><br><span class="line">      fetchedCallback = <span class="literal">null</span>;</span><br><span class="line">    &#125; esle &#123;</span><br><span class="line">      fetched = data;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, handleError);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在工程中使用时记得将其构建为静态资源文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">CopyPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;copy-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>,<span class="built_in">exports</span> =<span class="function">()=&gt;</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CopyPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">patterns</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">from</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src/wasm/hello.data&#x27;</span>),</span><br><span class="line">          <span class="attr">to</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist/hello.data&#x27;</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果你是通过 npm 包等形式发布 bundle 文件，可以通过修改胶水代码中的 <code>REMOTE_PACKAGE_BASE</code> 参数替换 <code>.data</code> 文件域名（比如发布到 cdn）来加速静态资源的下载。</p>
<h2 id="在小程序中使用"><a href="#在小程序中使用" class="headerlink" title="在小程序中使用"></a>在小程序中使用</h2><p>除了在浏览器容器中使用 WebAssembly，各小程序厂商如微信、支付宝等都已支持在各自的小程序中使用WebAssembly。但是在各小程序中进行了不同程度的封装，接下来看看如何在微信小程序中将 WebAssembly引</p>
<p>首先看下微信小程序官方的异同描述:</p>
<p>WXWebAssembly.instantiate(path, imports)</p>
<p>和标准 WebAssembly.instantiate 类似，差别是第一个参数只接受一个字符串类型的代码包路径，指向代码包内 .wasm 文件</p>
<p>与 WebAssembly 的异同</p>
<p>1、WxWebAssembly.instantiate(path,imports)方法，path为代码包内路径(支持.wasm和.wasm.br后缀)</p>
<p>2、支持 WxWebAssembly.Memory</p>
<p>3.支持 WxWebAssembly.Table</p>
<p>4、支持WXWebAssembly.Global</p>
<p>5、expont 支持函数、Memory、Table,iOS 平台暂不支持 Global</p>
<p>但是，要想在微信小程序中运行 WebAssembly，只看上面的描述远不能简单实现接入，必须要对 js 胶水层的进行一定的改造来完成接入</p>
<ol>
<li><p>在微信小程序中 <code>import.meta.url</code> 获取不到，可以直接改为 “&#x2F;“，注意 <code>.wasm</code> 文件在微信小程序中的文件路径即可:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.js</span></span><br><span class="line">wasmBinaryFile = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&#x27;hello.wasm&#x27;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>).<span class="property">href</span>;</span><br><span class="line">wasmBinaryFile =<span class="string">&#x27;hello.wasm&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>微信小程序中提供的是 WXWebAssembly，可以定义一个全局变量</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isWechat = <span class="keyword">typeof</span> wx== <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">WebAssembly</span> =isWechat ? <span class="title class_">WXWebAssembly</span> : <span class="title class_">WebAssembly</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>微信小程序不支持 xhr，需使用 <code>wx.request</code> 代替:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchRemotePackage</span>(<span class="params">packageName, packageSize, callback, errBack</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isWechat) &#123;</span><br><span class="line">    wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: packageName,</span><br><span class="line">    <span class="attr">responseType</span>: <span class="string">&#x27;arraybuffer&#x27;</span>,</span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">packageData</span>)&#123;</span><br><span class="line">      <span class="title function_">callback</span>(packageData);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>WXWebAssembly.instantiate(path,imports) 处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">instantiateArrayBuffer</span>(<span class="params">binaryFile, imports, receiver, info</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> r;</span><br><span class="line">  <span class="keyword">if</span> (isWechat) &#123;</span><br><span class="line">    r=<span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(<span class="string">&#x27;/&#x27;</span>+ wasmBinaryFile, info);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    r= <span class="title function_">getBinaryPromise</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">binary</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(binary, info);</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> r.<span class="title function_">then</span>(receiver, <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">err</span>(<span class="string">`failed to asynchronously prepare wasm: <span class="subst">$&#123;reason&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Warn on some common problems.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isFileURI</span>(wasmBinaryFile)) &#123;</span><br><span class="line">      <span class="title function_">err</span>(<span class="string">`warning: Loading from a file URl (<span class="subst">$&#123;wasmBinaryFile&#125;</span>) is not supported in mos`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">abort</span>(reason);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他，如:</p>
</li>
</ol>
<p>  a. <code>performance.now</code> 不支持，没有特殊需求可以使用 <code>Date.now</code> 替代</p>
<p>  b. Document、TextDecoder、TextEncoder 等不支持，可以写代码 hack 掉或者使用第三方库替代。在复杂的前端工程中引入 WebAssembly 可能会涉及到更多的工作，需要充分评估需求以及现有的代码，并确定哪些部分可以从引入 WebAssembly 中受益; 当然，必须注意代码的兼容性和性能测试，以保证引入 WebAssembly 不会引入新的问题。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>在需要执行高性能计算和数据密集型任务的场景中 WebAssembly 可以帮助我们实现更快的视频解码和编码;也可以帮助我们实现更快的游戏加载和渲染;甚至在安全防控方面也可以帮助我们实现更高效的安全检测和攻击防御以及未来结合大模型等在端上进行机器学习。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://speronis.github.io/2024/03/05/WebAssembly%E9%80%9F%E9%80%9A/" data-id="cm6rz8xo70000nwsydwkz6r1p" data-title="WebAssembly速通" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%A7%86%E9%87%8E%E5%88%86%E4%BA%AB/" rel="tag">视野分享</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web 视频播放一杆到底" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/09/web%20%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E4%B8%80%E6%9D%86%E5%88%B0%E5%BA%95/" class="article-date">
  <time class="dt-published" datetime="2020-12-09T04:24:22.000Z" itemprop="datePublished">2020-12-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/09/web%20%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E4%B8%80%E6%9D%86%E5%88%B0%E5%BA%95/">web视频播放一杆到底</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>毫无疑问，现在是短视频、直播的时代。视频内容逐渐代替图文形式成为网友们获取新鲜事物以及展现自我的一大媒介。随着5G的到来，2020年属于直播短视频爆发式增长的一年，电商平台也都涌入直播营销的大风口，成为了各自平台引流转化的关键。不管是用户还是开发者，我们处于这个风口中。本文将带你探索浏览器视频播放的奥秘。</p>
<h2 id="视频的构成"><a href="#视频的构成" class="headerlink" title="视频的构成"></a>视频的构成</h2><p>一个完整可播放的视频文件是由视频和音频两部分构成。视频和音频又有各自的封装格式（容器）和编码格式。</p>
<ol>
<li><strong>编码格式</strong>：常见的视频编码格式有：MPEG4、H.264、H.265 等。常见的音频编码格式有：MP3、AAC、WAV 等。</li>
<li><strong>封装格式</strong>：常见的视频封装格式有：MP4、FLV、mov、AVI、RMVB 等。</li>
</ol>
<h2 id="先理解几个名词"><a href="#先理解几个名词" class="headerlink" title="先理解几个名词"></a>先理解几个名词</h2><ol>
<li><strong>帧</strong>：就是影像动画中的最小单位的影像画面。一帧就是一张静止的图像。视频中的动画就是由多幅连续的帧画面构成。</li>
<li><strong>帧率</strong>：帧率是以帧为单位的图像在显示器上出现的频率，也叫帧速率，单位：赫兹（Hz）。简单理解为每秒播放图片的数量。</li>
<li><strong>码率</strong>：码率是比特率的俗称，是指每秒传送的比特数。</li>
<li><strong>FFmpeg</strong>：FFmpeg 是可以用来记录、转换数字视频和音频的一套计算机程序。FFmpeg 是在 linux 下开发，所以天生跨平台。它对音视频编码格式的支持比较全面，能对视频的各个组成部分进行编码。</li>
<li><strong>H264</strong>：通常被称之为 H.264&#x2F;AVC；是由国际标准化组织和国际电信联盟共同提出的继MPEG4之后的新一代数字视频压缩格式。采用 H.264 压缩后的数据具有低码率、高质量图像、容错能力强、网络适应性强等优点。</li>
<li><strong>MP4</strong>：MP4 是一种标准的数字多媒体容器格式；用于音频、视频的压缩编码，也可以存储字幕和静止图像，同时能以流的方式进行网络传输。</li>
<li><strong>fMP4（Fragmented MP4）</strong>：fMP4 是基于 MPEG-4 Part 12 的流媒体格式，与 MP4 很相似。简单来说 fMP4 区别于 MP4 最大的区别就是它能很好地适应流式播放。</li>
</ol>
<h2 id="浏览器播放视频"><a href="#浏览器播放视频" class="headerlink" title="浏览器播放视频"></a>浏览器播放视频</h2><ol>
<li><p><strong>video标签播放</strong>：在浏览器播放视频，可以使用 HTML5 原生的 video 标签。但其播放的格式使用一定限制的，目前 video 只支持三种格式 WebM、Ogg、MP4。</p>
<ul>
<li>WebM：WebM 文件使用 VP8 视频编解码器和 Vorbis 音频编解码器</li>
<li>Ogg：Ogg 文件使用 Theora 视频编解码器和 Vorbis 音频编解码器</li>
<li>MP4：MPEG 4 文件使用 H264 视频编解码器和 AAC 音频编解码器 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;video-box&quot;</span> <span class="attr">src</span>=<span class="string">&quot;//cloud.video.taobao.com/play/u/755731755/p/1/e/6/t/1/283631891407.mp4&quot;</span> <span class="attr">controls</span> <span class="attr">width</span>=<span class="string">&quot;400px&quot;</span> <span class="attr">heigt</span>=<span class="string">&quot;400px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure>
 在页面初始化完成后，video 标签会将整个 mp4 文件下载到浏览器，完成后即可播放。但是当 mp4 文件较大时，缓存时间就比较长，播放体验不好。当然也可以使用 <strong>video.js</strong> 来播放，这里就不赘述了。</li>
</ul>
</li>
<li><p><strong>播放HLS流</strong>：HLS（HTTP Live Streaming）是一个由 Apple 公司提出的基于 HTTP 的流媒体传输协议。视频的封装格式是 TS，编码格式是 H.264&#x2F;ACC，除了定义 TS 视频文件本身，还定义了用来控制播放的m3u8 文本文件。移动端大部分浏览器都支持，也就是说，你可以在移动端浏览器直接使用 vedio 标签直接加载一个 m3u8 文件播放视频或者直播。但在 PC 端只支持苹果的 safari 浏览器，其他浏览器想播放需要引入第三方库，如：hls.js：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/hls.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;video&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> video = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> videoSrc = <span class="string">&#x27;https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (<span class="title class_">Hls</span>.<span class="title function_">isSupported</span>()) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> hls = <span class="keyword">new</span> <span class="title class_">Hls</span>();</span></span><br><span class="line"><span class="language-javascript">    hls.<span class="title function_">loadSource</span>(videoSrc);</span></span><br><span class="line"><span class="language-javascript">    hls.<span class="title function_">attachMedia</span>(video);</span></span><br><span class="line"><span class="language-javascript">    hls.<span class="title function_">on</span>(<span class="title class_">Hls</span>.<span class="property">Events</span>.<span class="property">MANIFEST_PARSED</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        video.<span class="title function_">play</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>播放 HLS 流的逻辑很简单，首先根据提供的 m3u8 地址源通过 HTTP 请求获取到一级 index 文件内容，例如：</p>
 <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#EXTM3U</span></span><br><span class="line"><span class="comment">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=64000</span></span><br><span class="line">500kbps.<span class="attribute">m3u8</span></span><br><span class="line"><span class="comment">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=774000</span></span><br><span class="line">1000kbps.m3u8</span><br><span class="line"><span class="comment">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=887000</span></span><br><span class="line">500kbps.m3u8</span><br><span class="line"><span class="comment">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=7692000</span></span><br><span class="line">1000kbps.m3u8</span><br></pre></td></tr></table></figure>
<p><code>bandwidth</code> 指定视频流的码率，每一个 <code>#EXT-X-STEAM-INF</code> 的下一行是二级 index 文件的路径，可以是相对路径或者是绝对路径。请求到的二级文件内容如下：</p>
 <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#EXTM3U</span></span><br><span class="line"><span class="comment">#EXT-X-PLAYLIST-TYPE:VOD</span></span><br><span class="line"><span class="comment">#EXT-X-TARGETDURATION:10</span></span><br><span class="line"><span class="comment">#EXTINF:10,</span></span><br><span class="line">1000kbps-00001.<span class="attribute">ts</span></span><br><span class="line"><span class="comment">#EXTINF:10,</span></span><br><span class="line">1000kbps-<span class="number">00002</span>.ts</span><br><span class="line"><span class="comment">#EXTINF:10,</span></span><br><span class="line">1000kbps-<span class="number">00003</span>.ts</span><br><span class="line"><span class="comment">#EXTINF:10,</span></span><br><span class="line">1000kbps-<span class="number">00004</span>.ts</span><br><span class="line"><span class="comment">#EXTINF:10,</span></span><br><span class="line">... ...</span><br><span class="line"><span class="comment">#EXT-X-ENDLIST</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>可以从二级文件中读取到 ts 文件的路径，同样可以是相对路径或者绝对路径。<code>#EXTINF</code> 表示每个 ts 切片的时长。<code>#EXT-X-ENDLIST</code> 是视频结束标志，如果有这个标志也表明该流不是一个直播流。</p>
<pre><code>- **HLS播放的优势**：可以使用 http 协议请求数据流；可以切换不同的码率，实现无缝播放
- **劣势**：延迟较高，实时性差，一般延迟在 10s 以上，不适合做直播；ts 文件切片小且多，对存储和缓存都有一定的要求
</code></pre>
<ol start="3">
<li><p><strong>播放FLV流</strong>：FLV（Flash Video）是一种网络视频格式，FLV只能基于 flash 播放，但是由于 flash 存在很多安全问题已经被众多厂商抛弃，现在我们如果要在 H5 中播放 flv 格式的视频流可以使用 Blibli 的开源库：Flv.js，<code>flv.js</code>原理是解析视频的flv流并实时转换为 fmp4 格式，再通过 Media Source Extension 喂给浏览器的 <code>video</code> 标签。</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;flv.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;videoElement&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (flvjs.<span class="title function_">isSupported</span>()) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> videoElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;videoElement&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> flvPlayer = flvjs.<span class="title function_">createPlayer</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>: <span class="string">&#x27;flv&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>: <span class="string">&#x27;http://example.com/flv/video.flv&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    flvPlayer.<span class="title function_">attachMediaElement</span>(videoElement);</span></span><br><span class="line"><span class="language-javascript">    flvPlayer.<span class="title function_">load</span>();</span></span><br><span class="line"><span class="language-javascript">    flvPlayer.<span class="title function_">play</span>();</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>基于 Media Source Extensions 播放视频流</strong>：Media Source Extensions（媒体源扩展，缩写 MSE ）是一项 W3C 规范，MSE 允许 Javascript 为 audio 标签和video标签动态地构造媒体源。借助 MSE 的能力，我们可以将接收到的实时流通过 <code>blob url</code> 往 video 标签中灌入二进制数据（如 fmp4 格式流），或者使用 <code>canvas</code> 来实现直播。</p>
<ul>
<li><strong>简单实现</strong>：首先，判断浏览器是否支持 MediaSource： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> supportMediaSource = <span class="variable language_">window</span>.<span class="property">MediaSource</span> &amp;&amp;</span><br><span class="line"><span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">MediaSource</span>.<span class="property">isTypeSupported</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">MediaSource</span>.<span class="title function_">isTypeSupported</span>(<span class="string">&#x27;video/mp4; codecs=&quot;avc1.42c01f,mp4a.40.2&quot;&#x27;</span>);</span><br></pre></td></tr></table></figure>
MediaSource支持情况：<table>
<thead>
<tr>
<th></th>
<th>Chrome</th>
<th>Edge</th>
<th>Firefox</th>
<th>Safari</th>
<th>Opera</th>
<th>Android</th>
</tr>
</thead>
<tbody><tr>
<td>MediaSource</td>
<td>31</td>
<td>12</td>
<td>42</td>
<td>8</td>
<td>18</td>
<td>4.4.3</td>
</tr>
<tr>
<td>MediaSource() Constructor</td>
<td>31</td>
<td>12</td>
<td>42</td>
<td>8</td>
<td>15</td>
<td>4.4.3</td>
</tr>
<tr>
<td>activeSourceBuffers</td>
<td>23</td>
<td>12</td>
<td>42</td>
<td>8</td>
<td>15</td>
<td>4.4.3</td>
</tr>
<tr>
<td>addSourceBuffer</td>
<td>23</td>
<td>12</td>
<td>42</td>
<td>8</td>
<td>15</td>
<td>4.4.3</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ol>
<p>接下来新建 <code>MediaSource</code> 实例，并使用生成 blob url 加到 video 标签。并且监听 <code>sourceOpen</code> 事件来判断初始化完成。</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mediaSource = <span class="keyword">new</span> <span class="title class_">MediaSource</span>();</span><br><span class="line"><span class="keyword">const</span> video = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#video-box&#x27;</span>);</span><br><span class="line">video.<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(mediaSource);</span><br><span class="line"></span><br><span class="line">mediaSource.<span class="title function_">addEventListener</span>(<span class="string">&#x27;sourceopen&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</code></pre>
<p>接下来我们通过 websocket 获取原始视频流，处理后通过 <code>SourceBuffer</code> 喂给 <code>mediaSource</code></p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sourceBuffer = mediaSource.<span class="title function_">addSourceBuffer</span>(<span class="string">&#x27;video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;wss://xxx.websocket.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">ws.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params">evt</span>) &#123; </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Connection open...&quot;</span>); </span><br><span class="line">ws.<span class="title function_">send</span>(<span class="string">&quot;fetch Data&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line"><span class="comment">// 可以在灌入数据前进行转码等操作</span></span><br><span class="line">sourceBuffer.<span class="title function_">appendBuffer</span>(evt.<span class="property">data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.<span class="property">onclose</span> = <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Connection closed.&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</code></pre>
<p>通过MSE的方式我们可以将接收到的视频或者音频流进行端处理，配合WebWorker技术实现快速转码、支持多播，给我们无限的想象空间。</p>
<ol start="5">
<li><strong>H.265 视频播放</strong>：H.265 是 ITU-T VCEG 继 H.264 之后所制定的新的视频编码标准。H.265 标准围绕着现有的视频编码标准 H.264，保留原来的某些技术，同时对一些相关的技术加以改进。新技术使用先进的技术用以改善码流、编码质量、延时和算法复杂度之间的关系，达到最优化设置。但是由于浏览器不支持 H265 格式的流，所以我们无法直接播放。这时候可以使用 MSE 的方式在 <code>sourceBuffer.appendBuffer(evt.data)</code> 前将 <code>evt.data</code> 使用 libde265.js 等转码库转码后给到 <code>sourceBuffer</code>。或者使用业界成熟的播放器进行播放，如淘系的 @ali&#x2F;videox 播放器。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>越来越多的厂商更加偏向于H.265的编码格式，但是浏览器对该格式的支持度不友好的前提下我们不得不进行转码。使用MSE方式在浏览器端转码，则能借助GPU提高效率和降低延迟。但还是无法兼容所有的PC或者移动端浏览器，这条路还需要我们去继续探索。5G给互联网带来的福利不仅仅是在视频、直播的爆发，我相信web端图像视频技术也将突破现有的技术瓶颈，WebAssembly、硬件编码等图像渲染技术也将越来越丰富。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>baike.baidu.com&#x2F;item&#x2F;ffmpeg</li>
<li>github.com&#x2F;Bilibili&#x2F;fl…</li>
<li>developer.mozilla.org&#x2F;zh-CN&#x2F;docs&#x2F;…</li>
</ul>
<p><strong>标签</strong>：JavaScript</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://speronis.github.io/2020/12/09/web%20%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E4%B8%80%E6%9D%86%E5%88%B0%E5%BA%95/" data-id="cm6x4fwfy00006csy9w6l0xgr" data-title="web视频播放一杆到底" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%86%E9%87%8E%E5%88%86%E4%BA%AB/" rel="tag">视野分享</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/%E8%A7%86%E9%87%8E%E5%88%86%E4%BA%AB/" style="font-size: 10px;">视野分享</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">July 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/07/27/T2Code%20Agent/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/29/%E6%99%BA%E8%83%BD%E4%BD%93%E4%BA%A4%E4%BA%92%E5%8D%8F%E8%AE%AE/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/03/31/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2024/03/05/WebAssembly%E9%80%9F%E9%80%9A/">WebAssembly速通</a>
          </li>
        
          <li>
            <a href="/2020/12/09/web%20%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E4%B8%80%E6%9D%86%E5%88%B0%E5%BA%95/">web视频播放一杆到底</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 SPERONIS<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>